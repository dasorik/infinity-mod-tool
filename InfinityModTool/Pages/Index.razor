@page "/"
@page "/mods"
@page "/mods/{category}"
@inject InfinityModTool.Services.ModService modService;

@if (showLoadingIcon)
{
    <LoadingScreen></LoadingScreen>
}

@if (showConfirmation)
{
    <PopupConfirm Type="@AlertLevel.Warning" Title="@GetInstallMessage()" Message="This will modify your Disney Infinity 3.0 game installation" ConfirmedChanged="@(async (confirmed) => await InstallUninstall(confirmed, installContext))"></PopupConfirm>
}

@if (showReplaceConfirmation)
{
    <PopupConfirmReplace Type="@AlertLevel.Warning" Title="@GetInstallMessage()" Message="Please select a character below to replace, This will modify your Disney Infinity 3.0 game installation" ConfirmedPressed="@(async (id) => await InstallUninstall(id, installContext))" CancelPressed="() => showReplaceConfirmation = false" Options="@modService.GetAvailableReplacementCharacters(installContext.ModID)"></PopupConfirmReplace>
}

@if (showAlert)
{
    <PopupAlert Message="@alertMessage" OnDismissed="@(() => showAlert = false)"></PopupAlert>
}

@if (!string.IsNullOrEmpty(warningMessage))
{
    <BannerAlert Type="Warning" Message="@warningMessage"></BannerAlert>
}

@if (mods.Count() == 0)
{
    <h1 class="missing">No mod packs could be found</h1>
}

@foreach (var mod in mods)
{
    <CharacterButton IDName="@mod.ModID" DisplayName="@mod.DisplayName" DisplayImage="@mod.DisplayImageBase64" DisplayColor="@mod.DisplayColor" Icon="@modService.GetModIcon(mod.ModID)" Installed="@modService.IsModInstalled(mod.ModID)" OnClick="@SelectMod"></CharacterButton>
}

@code {
    [Parameter] public string category { get; set; }

    bool showLoadingIcon = false;
    bool showConfirmation = false;
    bool showReplaceConfirmation = false;
    bool showAlert = false;

    bool install = false;
    bool requiresReplacement = false;
    InfinityModTool.Data.ModInstallationData installContext;

    string warningMessage = null;
    string alertMessage = null;

    IEnumerable<InfinityModTool.Data.BaseModConfiguration> mods = new InfinityModTool.Data.BaseModConfiguration[] { };

    protected override void OnParametersSet()
    {
        if (string.IsNullOrEmpty(modService.Settings.SteamInstallationPath))
        {
            warningMessage = "Steam installation path has not been set, please set this via the settings tab";
            return;
        }

        mods = modService.GetModsForCategory(category);
    }

    void ShowConfirmationModal()
    {
        showConfirmation = true;
    }

    void SelectMod(string modID)
    {
        if (string.IsNullOrEmpty(modService.Settings.SteamInstallationPath))
        {
            alertMessage = "Steam installation path has not been set, please set this in 'Settings'";
            showAlert = true;
            return;
        }

        var modData = modService.GetMod(modID);
        install = !modService.IsModInstalled(modID);
        installContext = new Data.ModInstallationData() { ModID = modData.ModID, ModCategory = modData.ModCategory };

        if (modData.ModCategory == "Character")
            SelectCharacterMod(modData as Data.CharacterModConfiguration);
        else
            showConfirmation = true;
    }

    void SelectCharacterMod(Data.CharacterModConfiguration modData)
    {
        requiresReplacement = modData?.ReplaceCharacter ?? false;

        if (requiresReplacement && install)
            showReplaceConfirmation = true;
        else
            showConfirmation = true;
    }

    async Task InstallUninstall(string selectedCharacterID, Data.ModInstallationData modification)
    {
        modification.Parameters.Add("ReplacementCharacter", selectedCharacterID);
        await InstallUninstall(true, modification);
    }

    async Task InstallUninstall(bool confirm, Data.ModInstallationData modification)
    {
        this.showConfirmation = false;
        this.showReplaceConfirmation = false;

        // User has cancelled operation
        if (!confirm)
            return;

        showLoadingIcon = true;

        if (install)
            await modService.InstallCharacterMod(modification);
        else
            await modService.UninstallMod(modification.ModID);

        showLoadingIcon = false;
    }

    string GetInstallMessage()
    {
        return install ? "Install Mod?" : "Uninstall Mod?";
    }
}